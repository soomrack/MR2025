#include <DHT.h>


#define PUMP_PIN 5
#define LIGHT_PIN 6
#define HEAT_PIN 4
#define VENT_PIN 7

#define DHT_PIN 12
#define LIGHT_SENSOR_PIN A0
#define SOIL_SENSOR_PIN A3 // Для простоты оставим только один датчик почвы

/
const int TEMP_MIN = 20;
const int TEMP_MAX = 27;

// Влажность воздуха
const int AIR_HUMIDITY_MAX = 75;

// Почва  больше = суше)
const int SOIL_DRY_THRESHOLD = 500;
const unsigned long PUMP_MAX_DURATION = 30000UL; // 30 секунд полива

// Освещение ( меньше = темнее)
const int LIGHT_MIN_THRESHOLD = 405;

// Вентиляция по расписанию
const unsigned long VENT_INTERVAL = 3600000UL; // 1 час
const unsigned long VENT_DURATION = 60000UL; // 1 минута

// Цикл День/Ночь (для теста
const unsigned long DAY_DURATION = 10UL * 1000UL;
const unsigned long NIGHT_DURATION = 10UL * 1000UL;

DHT dht(DHT_PIN, DHT11);
unsigned long currentMillis = 0;

// Показания датчиков
int air_temperature = 0;
int air_humidity = 0;
int soil_moisture = 0;
int light_level = 0;
bool dht_normal = false;

// Состояние системы
bool isNight = false;
unsigned long cycleStart = 0;

// Состояние устройств
bool pump_is_on = false;
bool light_is_on = false;
bool heater_is_on = false;
bool vent_is_on = false;

// Таймеры для вентиляции
unsigned long lastVentTime = 0;
bool vent_timer_active = false;

// Таймер для насоса
unsigned long lastPumpStart = 0;



void read_all_sensors() {
    // 1. Чтение DHT
    int humid_data = dht.readHumidity();
    int temp_data = dht.readTemperature();
    
    if (isnan(humid_data) || isnan(temp_data)) {
        dht_normal = false;
    } else {
        air_humidity = humid_data;
        air_temperature = temp_data;
        dht_normal = true;
    }

    // 2. Чтение аналоговых датчиков
    soil_moisture = analogRead(SOIL_SENSOR_PIN);
    light_level = analogRead(LIGHT_SENSOR_PIN);
}


// цикл день-ночь

void updateDayNight() {
    unsigned long elapsed = currentMillis - cycleStart;
    
    if (elapsed < DAY_DURATION) {
        isNight = false; // День
    } else if (elapsed < DAY_DURATION + NIGHT_DURATION) {
        isNight = true; // Ночь
    } else {
        cycleStart = currentMillis; // Сброс цикла
        isNight = false; // Начинаем новый день
    }
}



// --- 1. Освещение ---
void algorithm_lighting() {
    // Включаем свет, только если ДЕНЬ И освещение НИЖЕ порога
    if (!isNight && light_level < LIGHT_MIN_THRESHOLD) {
        light_is_on = true;
    } else {
        light_is_on = false;
    }
}

// --- 2. Температура ---
void algorithm_temperature() {
    if (!dht_normal) return;

    if (air_temperature < TEMP_MIN) {
        heater_is_on = true; // Слишком холодно -> Включить обогрев
    } else if (air_temperature > TEMP_MAX) {
        heater_is_on = false; // Слишком жарко/нормально -> Выключить обогрев
    }
    // Если температура между MIN и MAX, состояние heater_is_on не меняется.
}

// --- 3. Вентиляция по расписанию (Таймер) ---
void algorithm_vent_schedule() {
    // Если таймер не активен И пора проветривать
    if (!vent_timer_active && (currentMillis - lastVentTime >= VENT_INTERVAL)) {
        vent_timer_active = true;
        lastVentTime = currentMillis; // Запоминаем время начала проветривания
    }

    // Если таймер активен И время проветривания вышло
    if (vent_timer_active && (currentMillis - lastVentTime >= VENT_DURATION)) {
        vent_timer_active = false;
        lastVentTime = currentMillis; // Запоминаем время окончания проветривания
    }
}

// --- 4. Полив ---
void algorithm_watering() {
    bool soil_is_dry = (soil_moisture > SOIL_DRY_THRESHOLD);

    // Если нужна вода И насос выключен, включаем насос
    if (soil_is_dry && !pump_is_on) {
        pump_is_on = true;
        lastPumpStart = currentMillis;
    } 
    
    // Если вода не нужна И насос включен, выключаем насос
    else if (!soil_is_dry && pump_is_on) {
        pump_is_on = false;
    }

    // Защита от слишком долгой работы насоса (Таймаут)
    if (pump_is_on && (currentMillis - lastPumpStart > PUMP_MAX_DURATION)) {
        pump_is_on = false;
        // Чтобы избежать немедленного включения, увеличим порог сухости временно
    }
}


void apply_power_controls() {
    // Лампа
    digitalWrite(LIGHT_PIN, light_is_on ? HIGH : LOW);
    
    // Обогреватель
    digitalWrite(HEAT_PIN, heater_is_on ? HIGH : LOW);

    // Насос
    digitalWrite(PUMP_PIN, pump_is_on ? HIGH : LOW);
    
    // Вентиляция: включается, если любое из условий TRUE
    bool high_humidity = (dht_normal && air_humidity > AIR_HUMIDITY_MAX);
    bool need_ventilation = (
        vent_timer_active || // 1. По расписанию
        high_humidity ||     // 2. Слишком высокая влажность
        heater_is_on ||      // 3. Работает обогрев
        pump_is_on           // 4. Идет полив
    );
    
    vent_is_on = need_ventilation;
    digitalWrite(VENT_PIN, vent_is_on ? HIGH : LOW);
}


void serial_log() {
    static unsigned long lastSerial = 0;
    const unsigned long serialInterval = 5000UL;
    
    if (currentMillis - lastSerial < serialInterval) return;
    lastSerial = currentMillis;

    Serial.println("--- STATUS TEPLITSA ---");
    Serial.print("TEMP: "); Serial.print(air_temperature); Serial.print("C | HUM: "); Serial.print(air_humidity); Serial.println("%");
    Serial.print("SOIL: "); Serial.print(soil_moisture); Serial.print(" | LIGHT: "); Serial.println(light_level);
    
    Serial.println("--- УПРАВЛЕНИЕ ---");
    Serial.print("LIGHT: "); Serial.print(light_is_on ? "ON" : "OFF");
    Serial.print(" | HEAT: "); Serial.print(heater_is_on ? "ON" : "OFF");
    Serial.print(" | PUMP: "); Serial.println(pump_is_on ? "ON" : "OFF");
    Serial.print("VENT: "); Serial.print(vent_is_on ? "ON" : "OFF");
    Serial.print(" (Таймер: "); Serial.print(vent_timer_active ? "ДА" : "НЕТ");
    Serial.print(", Влажность: "); Serial.print(air_humidity > AIR_HUMIDITY_MAX ? "ДА" : "НЕТ"); Serial.println(")");
    Serial.println("-------------------------");
}

void setup() {
    Serial.begin(9600);
    dht.begin();

    
    pinMode(PUMP_PIN, OUTPUT);
    pinMode(LIGHT_PIN, OUTPUT);
    pinMode(HEAT_PIN, OUTPUT);
    pinMode(VENT_PIN, OUTPUT);
    
    // Начальное выключение всех устройств
    digitalWrite(PUMP_PIN, LOW);
    digitalWrite(LIGHT_PIN, LOW);
    digitalWrite(HEAT_PIN, LOW);
    digitalWrite(VENT_PIN, LOW);
    
    cycleStart = millis(); // Запуск счетчика дня/ночи
    lastVentTime = millis(); // Запуск счетчика вентиляции
    Serial.println("Система 'Теплица' запущена.");
}


void loop() {
    currentMillis = millis(); // Запоминаем текущее время

    // Чтение всех датчиков
    read_all_sensors();
    
    // Принятие решений
    updateDayNight();
    algorithm_lighting();
    algorithm_temperature();
    algorithm_vent_schedule();
    algorithm_watering();

    //  Применение решений к устройствам
    apply_power_controls();
    
    // 4. Отладка
    serial_log();
    
    delay(100); // Небольшая пауза для стабильности
}
